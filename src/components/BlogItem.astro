---
import { urlFor } from "@/lib/sanity";

type Props = {
  title: string;
  description: string;
  mainImage: object | null;
  publishedAt: string;
  external_link?: string;
  slug: { current: string };
  short_content: string;
  is_art_only: boolean;
};

const {
  title,
  description,
  mainImage,
  publishedAt,
  external_link,
  slug,
  short_content,
  is_art_only,
}: Props = Astro.props;

const imageUrl = () => {
  if (!mainImage) return null;
  return urlFor(mainImage).quality(80).height(540).width(960).url();
};

const isArtOnly = is_art_only && !!mainImage;

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

// Typically we want to link to the blog post, but if there is an external link, we want to link to that
// But slug url takes precedence over external link
const blogUrl = slug.current ? `/blog/${slug.current}` : external_link;
const isExternal = !!external_link;
---

<a
  href={blogUrl}
  class="flex flex-col h-48 rounded-lg group/blog-item relative overflow-clip"
  style="border: 1px solid var(--color-border); transition: border-color 0.2s ease"
  onmouseover="this.style.borderColor='var(--color-accent)'"
  onmouseout="this.style.borderColor='var(--color-border)'"
>
  {
    isArtOnly && (
      <img
        src={imageUrl()}
        alt={title}
        class="w-full h-full object-cover rounded-t-lg mb-4 absolute top-0 left-0 z-[-2]"
      />
      <div class="absolute top-0 left-0 w-full h-full bg-black/30 z-[-1]"/>
      <p class=" bg-bg text-text-muted px-2 py-1 rounded-full text-xs w-max absolute top-4 left-4 z-10">Art</p>
      <div class="flex-grow"/>
    )
  }

  <h2
    class={`text-xl leading-tight px-4 line-clamp-2 pt-4 ${isArtOnly ? "text-white" : "text-text"}`}
  >
    {title}
  </h2>

  {
    description && !isArtOnly && (
      <p
        class="leading-relaxed mb-4 px-4 line-clamp-2 text-text-muted"
      >
        {description}
      </p>
    )
  }

  <!-- short content -->
  {
    !isArtOnly && (
      <p
        class="leading-relaxed mb-4 text-sm px-4 flex-grow line-clamp-3"
        style="color: var(--color-text-muted)"
      >
        {short_content}
      </p>
    )
  }

  <div class="flex items-center justify-between gap-2 px-4 pb-4">
    <p class={`text-xs ${isArtOnly ? "text-white" : "text-text-muted"}`}>
      {formatDate(publishedAt)}
    </p>
    {
      isExternal && (
        <span
          class="text-xs px-1 rounded flex-shrink-0"
          style="border: 1px solid var(--color-border); color: var(--color-text-muted); background-color: var(--color-accent-bg)"
        >
          ext
        </span>
      )
    }
  </div>
</a>
